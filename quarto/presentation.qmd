---
title: "üç∑ √Ä boire üçª"
subtitle: "*L'histoire d'un breuvage*"
author: "`Guillaume DEVANT` & `Corentin DUCLOUX`"
format: 
    revealjs:
        theme: serif
        background-transition: fade
        transition: slide
        footer: "--- Machine Learning ---"
        logo: https://corentinducloux.fr/dossier_img/mecen_transparent.png
---

<link rel="stylesheet" 
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


## Introduction

- Une immersion en territoire alcoolis√© s'impose...
<div style="display: flex; justify-content: center; align-items: center; height: 90vh;">
<iframe width="800" height="380" src="https://www.youtube.com/embed/mZ6xNxpuIOQ" title="Bodh&#39;Aktan - √Ä boire" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></div>

- *‚ÄúPour savoir qu'un verre √©tait de trop, encore faut-il l'avoir bu.‚Äù* - Georges Courteline

## Introduction

- Le 18 janvier approche, une date en apparence anodine mais tr√®s importante pour nos deux comp√®res.
- Pour cette journ√©e festive, nos 2 protagonistes se rendirent sur `vinatis.com` pour trouver un breuvage.
- Et c'est √† ce moment que l'histoire prend racine...

![](img\bouteille_dieu.png){fig-align="center"}

## Scraping

1. Scraping des liens
2. Scraping d'une bouteille `mystical_soup.py`
3. Stockage JSON `scraping_functions.py`

![](img\bouteille_scrap.png){fig-align="center"}

## Scraping, Partie I {.smaller}

`scraping_functions` $\Rightarrow$ Le coeur du scraper

1. Construit des URL avec *query parameters* en utilisant le package `yarl`.

```python
URL_INIT = URL.build(scheme="https", host="vinatis.com")
WHITE = "achat-vin-blanc"
RED = "achat-vin-rouge"
ROSE = "achat-vin-rose"

>>> URL_INIT / WHITE % {"page": 1, "tri": 7}
... URL('https://vinatis.com/achat-vin-blanc?page=1&tri=7')
```

2. `create_session` cr√©e une session HTML avec un User-Agent et un Proxy al√©atoire, pouvant changer entre les requ√™tes.
3. Poss√®de un d√©corateur `@random_waiter(min, max)` permettant de g√©n√©rer un temps d'attente al√©atoire entre les deux bornes sp√©cifi√©es entre chaque requ√™te **GET** pour √©viter d'envoyer trop de requ√™tes dans un laps de temps r√©duit.
4. `create_all_wine_urls` permet de cr√©er l'ensemble des liens **href**.
5. `export_wine_links` permet d'exporter ces liens dans un fichier CSV.

## Scraping, Partie II {.smaller}

1. On va ensuite requ√™ter ces liens **href** avec `extract_all_pages` et r√©cup√©rer les pages brutes en HTML.
2. La fonction `scraping` du module `mystical_soup` va permettre d'extraire toutes les informations int√©ressantes de la page brute et renvoyer la dataclass `Vin` s√©rialisable en *JSON*.

<i class="fa-solid fa-wine-bottle"></i> *Exemple* d'un `Vin` et ses caract√©ristiques s√©rialis√©s en *JSON* :

```json
{
        "name": "PINOT NOIR 2019 LAS PIZARRAS - ERRAZURIZ",
        "capacity": "0,75 L",
        "price": "94,90 ‚Ç¨",
        "price_bundle": null,
        "characteristics": "Vin Rouge / Chili / Central Valley / Aconcagua Valley DO / 13,5 % vol / 100% Pinot noir",
        "note": null,
        "keywords": [
            "El√©gance",
            "Finesse",
            "Harmonie"
        ],
        "others": null,
        "picture": "https://www.vinatis.com/67234-detail_default/pinot-noir-2019-las-pizarras-errazuriz.png",
        "classification": null,
        "millesime": "2019",
        "cepage": "100% Pinot noir",
        "gouts": "Rouge Charnu et fruit√©",
        "par_gouts": "Puissant",
        "oeil": "Robe rubis aux reflets violets.",
        "nez": "Nez complexe sur la griotte, les √©pices et les champignons (truffe).",
        "bouche": "Bouche fruit√©e et florale. Tanins structur√©s, √©l√©gants et fins. finale harmonieuse et persistante.",
        "temperature": "8-10¬∞C",
        "service": "En bouteille ou en carafe",
        "conservation_1": "2026",
        "conservation_2": "A boire et √† garder",
        "accords_vins": "Ap√©ritif, Entr√©e, Charcuterie, Viande rouge, Viande blanche, Volaille, Gibier, Champignon, Barbecue, Cuisine du monde, Fromage, Dessert fruit√©, Dessert chocolat√©",
        "accords_reco": "Gigot d'agneau aux herbes de Provence; Tikka massala; Plateau de fromages."
    }
```

## Cleaning {.smaller}

Mais ce *JSON* brut doit √™tre nettoy√© et consid√©rablement restructur√© !

1. Nous avons choisi d'utiliser `polars` üêª et non pas `pandas` üêº
2. Toutes les fonctions de nettoyage sont contenues dans `bear_cleaner.py`
3. La fonction `super_pipe` permet de chainer toutes les transformations dans un pipeline propre pour structurer notre **Dataframe**.

![](img\pandas_vs_polars.png){fig-align="center"}


## Machine Learning (ML)

1. ‚û∂ Optimisation des param√®tres (`models.py`)
2. üèπ Prediction sur les donn√©es de tests (`prediction.py`)


![](img\bouteille_ecole.png){fig-align="center"}

## ML : Optimisation ‚û∂ {.smaller}

1. Choix des **21 variables explicatives** et des **6 mod√®les** 
2. $\Rightarrow$ optimisation des param√®tres avec une Cross Validation

- Avec `optimisation_script.py` on optimise les param√®tres des mod√®les :

```CSV
Mod√®le,Score Test,Score Entrainement,Ecart-Type Test,Ecart-Type Train,Param√®tres,Score Test data,Mode
Random Forest,0.934,0.941,0.007,0.007,"{'entrainement__max_depth': 9, 'entrainement__n_estimators': 30, 'imputation__strategy': 'median'}",0.9301745635910225,classification
K Neighbors,0.954,0.965,0.012,0.003,"{'entrainement__n_neighbors': 5, 'imputation__strategy': 'median'}",0.9600997506234414,classification
R√©seaux de neurones,0.976,0.997,0.007,0.001,"{'entrainement__hidden_layer_sizes': (100,), 'entrainement__max_iter': 1000, 'entrainement__solver': 'adam', 'imputation__strategy': 'median'}",0.9800498753117207,classification
Boosting,0.975,1.0,0.009,0.0,"{'entrainement__learning_rate': 0.5, 'entrainement__n_estimators': 200, 'imputation__strategy': 'median'}",0.9812967581047382,classification
Ridge,0.979,0.983,0.009,0.002,"{'entrainement__alpha': 0.015625, 'imputation__strategy': 'mean'}",0.9812967581047382,classification
Support Vector,0.981,0.992,0.008,0.002,"{'entrainement__C': 3.281341424030552, 'imputation__strategy': 'median'}",0.9825436408977556,classification

```

- Une fois que l'on a les meilleurs param√®tres pour chaque mod√®le on peut passer aux pr√©dictions

## ML : Pr√©diction üèπ {.smaller} 

- Deux types de pr√©dictions :
    - Classification sur la type de vin (Vin Rouge / Blanc / Ros√©)
    - Regression sur le prix d'une bouteille de vin
- Avec `prediction_script.py` on optimise r√©alise les pr√©dictions avec tous les mod√®les

```CSV
name,type,random_forest,boosting,ridge,knn,mlp,support_vector
LES CARLINES 2021 - MAS HAUT BUIS,Vin Rouge,Vin Rouge,Vin Rouge,Vin Rouge,Vin Rouge,Vin Rouge,Vin Rouge
LA BARGEMONE ROSE 2022 - COMMANDERIE DE LA BARGEMONE,Vin Ros√©,Vin Blanc,Vin Ros√©,Vin Ros√©,Vin Ros√©,Vin Ros√©,Vin Ros√©
TEMPRANILLO 2021- VEGA DEMARA,Vin Rouge,Vin Rouge,Vin Rouge,Vin Rouge,Vin Rouge,Vin Rouge,Vin Rouge
CH√ÇTEAUNEUF DU PAPE - ALCHIMIE 2020 - DOMAINE DES 3 CELLIER,Vin Rouge,Vin Rouge,Vin Rouge,Vin Rouge,Vin Rouge,Vin Rouge,Vin Rouge
```

- Pour chacun des 800 vins qui n'ont pas servit dans notre CV on r√©alise une pr√©diction par chacun de nos 6 mod√®les, le tout stock√© dans un CSV.

Afin de visualiser tous nos r√©sultats une application serait id√©al...

## Application {.smaller} 

## R√©f√©rences

- Images : **DALL-E**
